<!DOCTYPE html>
<html>
<head>
    <title>Xác minh IP</title>
    <script src="https://telegram.org/js/telegram-web-app.js?v=1.8.5"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            text-align: center;
            padding: 20px;
            background: linear-gradient(135deg, #74ebd5, #acb6e5);
            margin: 0;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            max-width: 400px;
            width: 100%;
        }
        h1 {
            color: #2c3e50;
            font-size: 28px;
            margin-bottom: 20px;
        }
        p {
            font-size: 18px;
            color: #34495e;
            margin: 15px 0;
            line-height: 1.5;
        }
        button {
            padding: 12px 25px;
            font-size: 16px;
            font-weight: bold;
            background: linear-gradient(90deg, #1e90ff, #00b4db);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: transform 0.1s, box-shadow 0.3s;
        }
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
        }
        button:disabled {
            background: #bdc3c7;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        .loading {
            color: #7f8c8d;
            font-style: italic;
        }
        .error {
            color: #e74c3c;
            font-weight: bold;
        }
        .ip {
            color: #27ae60;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Xác minh IP</h1>
        <p id="ip-status" class="loading">Đang lấy IP...</p>
        <button id="send-ip" disabled>Gửi IP</button>
    </div>

    <script>
        const statusElement = document.getElementById("ip-status");
        const sendButton = document.getElementById("send-ip");

        // Khởi tạo Telegram Web App (không kiểm tra initDataUnsafe)
        if (typeof Telegram !== 'undefined' && Telegram.WebApp) {
            Telegram.WebApp.ready();
            Telegram.WebApp.expand();

            // Log thông tin môi trường (chỉ để debug)
            console.log("Phiên bản Telegram Web App:", Telegram.WebApp.version);
            console.log("Nền tảng:", Telegram.WebApp.platform);
            console.log("Thông tin chủ đề:", JSON.stringify(Telegram.WebApp.themeParams, null, 2));
            console.log("initData (raw):", Telegram.WebApp.initData);
            console.log("initDataUnsafe (chi tiết):", JSON.stringify(Telegram.WebApp.initDataUnsafe, null, 2));
        } else {
            console.error("Không thể khởi tạo Telegram Web App.");
            // Vẫn tiếp tục lấy IP, không dừng lại
        }

        // Lấy IP từ API
        fetch('https://api.ipify.org?format=json')
            .then(response => response.json())
            .then(data => {
                const ip = data.ip;
                statusElement.textContent = `IP của bạn: ${ip}`; // Hiển thị IP trên màn hình
                statusElement.classList.remove("loading");
                statusElement.classList.add("ip");
                sendButton.disabled = false; // Kích hoạt nút Gửi IP

                // Gửi IP về bot khi bấm nút
                sendButton.addEventListener("click", () => {
                    const ipData = JSON.stringify({ ip: ip });
                    console.log("Gửi dữ liệu:", ipData);
                    statusElement.textContent = `IP của bạn: ${ip}\nĐang gửi IP...`; // Cập nhật trạng thái khi gửi
                    statusElement.classList.remove("ip");
                    statusElement.classList.add("loading");
                    Telegram.WebApp.sendData(ipData); // Gửi dữ liệu về bot
                    Telegram.WebApp.close(); // Đóng Mini App sau khi gửi
                });
            })
            .catch(error => {
                console.error("Lỗi khi lấy IP:", error);
                statusElement.textContent = "Lỗi khi lấy IP: " + error.message; // Hiển thị lỗi trên màn hình
                statusElement.classList.remove("loading");
                statusElement.classList.add("error");
                sendButton.disabled = true; // Vô hiệu hóa nút nếu có lỗi

                // Thêm nút "Thử lại"
                const retryButton = document.createElement("button");
                retryButton.textContent = "Thử lại";
                retryButton.style.marginTop = "10px";
                retryButton.addEventListener("click", () => {
                    location.reload(); // Tải lại Mini App để thử lại
                });
                document.querySelector(".container").appendChild(retryButton);
            });
    </script>
</body>
</html>
